<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pagamento Confirmado!</title>
<link rel="icon" type="image/png" href="img/favicon.png">
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background:
    radial-gradient(circle at top, rgba(255, 200, 0, 0.04), transparent 60%),
    #000;
}
#parallax-wrapper {
  perspective: 1200px;
  transform-style: preserve-3d;
}
.card-depth {
  transition: transform 0.2s ease-out;
  will-change: transform;
}
.disabled {
  opacity: 0.4;
  pointer-events: none;
}
</style>
</head>

<body class="bg-black text-white font-sans">

<div id="parallax-wrapper">
<div class="max-w-xl mx-auto p-6">

<h1 class="text-3xl mb-4 font-bold text-center glow-float">Pagamento recebido!</h1>

<p id="status-msg" class="text-center text-gray-400 mb-6">
Validando pagamento com o Mercado Pago...
</p>

<form id="pedido-form"
      action="https://formsubmit.co/saintwwmofficial@gmail.com"
      method="POST"
      class="space-y-4 card-depth disabled">

  <input type="hidden" name="_subject" value="Novo Pedido Echo Beads">
  <input type="hidden" name="_captcha" value="false">
  <input type="hidden" name="_next" value="https://saintsgs-hub.github.io/confirmado.html">
  <input type="hidden" name="_honeypot" value="">

  <!-- CAMPOS OCULTOS -->
  <input type="hidden" name="ip">
  <input type="hidden" name="pais">
  <input type="hidden" name="cidade">
  <input type="hidden" name="horario">
  <input type="hidden" name="produto">
  <input type="hidden" name="txid">

  <!-- CAMPOS VISÍVEIS -->
  <input class="w-full p-2 rounded bg-zinc-800"
         name="nick"
         placeholder="Nome no jogo"
         required>

  <input class="w-full p-2 rounded bg-zinc-800"
         name="id"
         placeholder="ID da conta (somente números)"
         required
         inputmode="numeric"
         pattern="[0-9]+"
         oninput="this.value = this.value.replace(/[^0-9]/g, '')">

  <input class="w-full p-2 rounded bg-zinc-800"
         name="telefone"
         placeholder="WhatsApp (Ex: +55 11 99999-9999)"
         required
         inputmode="tel"
         pattern="[0-9+\-\s]+"
         oninput="this.value = this.value.replace(/[^0-9+\-\s]/g, '')">

  <input class="w-full p-2 rounded bg-zinc-800"
         type="email"
         name="email_cliente"
         placeholder="Seu e-mail"
         required>

  <button type="submit" class="w-full bg-yellow-500 text-black py-2 rounded-lg">
    Confirmar Entrega
  </button>

</form>

<!-- AVISO -->
<div class="mt-10 bg-zinc-900 border border-yellow-500 text-yellow-400 p-4 rounded text-sm text-center card-depth">
<strong>Atenção:</strong><br>
O formulário só será liberado após confirmação real do pagamento.
</div>

</div>
</div>

<script src="js/effects.js"></script>

<script>
/* ================================
   BLOQUEIO DE ACESSO DIRETO
================================ */
if (!sessionStorage.getItem("checkout_iniciado")) {
  window.location.href = "index.html";
}

/* ================================
   GEOLOCALIZAÇÃO
================================ */
let geo = { ip: "N/A", country: "N/A", city: "N/A" };

fetch("https://ipinfo.io/json")
  .then(r => r.json())
  .then(d => {
    geo.ip = d.ip || "N/A";
    geo.country = d.country || "N/A";
    geo.city = d.city || "N/A";
  });

/* ================================
   PRODUTO (LOCALSTORAGE)
================================ */
const produtoLS = localStorage.getItem("produto") || "Produto não identificado";

/* ================================
   TXID (URL)
================================ */
const params = new URLSearchParams(window.location.search);
const txid =
  params.get("payment_id") ||
  params.get("collection_id") ||
  params.get("id");

/* ================================
   VALIDAÇÃO IMEDIATA (ETAPA 5)
================================ */
fetch("https://saint-echo-backend.neuroniosgames.workers.dev/submit-order", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ txid })
})
.then(r => {
  if (!r.ok) throw new Error("Pagamento não aprovado");
  return r.json();
})
.then(() => {
  document.getElementById("status-msg").innerText =
    "Pagamento confirmado. Preencha os dados para entrega.";
  document.getElementById("pedido-form").classList.remove("disabled");
})
.catch(() => {
  alert("Pagamento não validado. Acesso bloqueado.");
  window.location.href = "index.html";
});

/* ================================
   SUBMIT FINAL
================================ */
document.getElementById("pedido-form").addEventListener("submit", function () {

  const now = new Date();
  const dia = now.toLocaleDateString("pt-BR");
  const horario = now.toLocaleTimeString("pt-BR");

  this.ip.value = geo.ip;
  this.pais.value = geo.country;
  this.cidade.value = geo.city;
  this.horario.value = `${dia} ${horario}`;
  this.produto.value = produtoLS;
  this.txid.value = txid;

});
</script>

</body>
</html>
