<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Concluindo Compra ⵚ..</title>
<link rel="icon" type="image/png" href="img/favicon.png">
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background:
    radial-gradient(circle at top, rgba(255, 200, 0, 0.04), transparent 60%),
    #000;
}
#parallax-wrapper {
  perspective: 1200px;
  transform-style: preserve-3d;
}
.card-depth {
  transition: transform 0.2s ease-out;
  will-change: transform;
}
.disabled {
  opacity: 0.4;
  pointer-events: none;
}

/* STATUS VISUAL */
.status {
  font-weight: bold;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 20px;
}
.status-pending {
  color: #facc15;
  box-shadow: 0 0 12px rgba(250,204,21,0.5);
}
.status-approved {
  color: #4ade80;
  box-shadow: 0 0 14px rgba(74,222,128,0.6);
}
.status-refused {
  color: #f87171;
  box-shadow: 0 0 14px rgba(248,113,113,0.6);
}
</style>
</head>

<body class="bg-black text-white font-sans">

<div id="parallax-wrapper">
<div class="max-w-xl mx-auto p-6">

<h1 class="text-3xl mb-2 font-bold text-center glow-float">
continue para entrega
</h1>

<div id="status-box"
     class="status status-pending text-center">
Pagamento em análise pelo Mercado Pago
</div>

<button
  id="retry-btn"
  class="hidden w-full bg-zinc-900 border border-yellow-500 text-yellow-400 py-2 rounded-lg mb-6">
<strong>VERIFICAR PAGAMENTO NOVAMENTE</strong>
</button>

<!-- FORM agora é APENAS visual (sem action / submit real) -->
<form id="pedido-form" class="space-y-4 card-depth disabled">

  <input class="w-full p-2 rounded bg-zinc-800"
         name="nick"
         placeholder="Nome no jogo"
         required>

  <input class="w-full p-2 rounded bg-zinc-800"
         name="id"
         placeholder="ID da conta (somente números)"
         required
         inputmode="numeric"
         pattern="[0-9]+"
         oninput="this.value = this.value.replace(/[^0-9]/g, '')">

  <input class="w-full p-2 rounded bg-zinc-800"
         name="telefone"
         placeholder="WhatsApp"
         required>

  <input class="w-full p-2 rounded bg-zinc-800"
         type="email"
         name="email_cliente"
         placeholder="Seu e-mail"
         required>

  <!-- BOTÃO NÃO É SUBMIT -->
  <button
    id="confirmar-entrega"
    type="button"
    class="w-full bg-yellow-500 text-black py-2 rounded-lg">
Confirmar Entrega
  </button>

</form>

<div class="mt-8 bg-zinc-900 border border-yellow-500 text-yellow-400 p-4 rounded text-sm text-center card-depth">
<strong>Atenção:</strong><br>
O formulário só é liberado após confirmação real do pagamento.
</div>

</div>
</div>

<script src="js/effects.js"></script>

<script>
const form = document.getElementById("pedido-form");
const statusBox = document.getElementById("status-box");
const retryBtn = document.getElementById("retry-btn");
const confirmarBtn = document.getElementById("confirmar-entrega");

const params = new URLSearchParams(window.location.search);
const txid =
  params.get("payment_id") ||
  params.get("collection_id") ||
  params.get("id");

/* ================================
   VALIDAÇÃO DE PAGAMENTO
================================ */
function validarPagamento() {
  statusBox.className = "status status-pending text-center";
  statusBox.innerText = "Pagamento em análise pelo Mercado Pago";
  retryBtn.classList.add("hidden");

  fetch("https://saint-echo-backend.neuroniosgames.workers.dev/submit-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ txid })
  })
  .then(r => {
    if (!r.ok) throw new Error();
    return r.json();
  })
  .then(() => {
    statusBox.className = "status status-approved text-center";
    statusBox.innerText = "Pagamento aprovado ✔";
    form.classList.remove("disabled");
  })
  .catch(() => {
    statusBox.className = "status status-pending text-center";
    statusBox.innerText =
      "Pagamento ainda não confirmado. Verifique novamente.";
    retryBtn.classList.remove("hidden");
  });
}

retryBtn.addEventListener("click", validarPagamento);
validarPagamento();

/* ================================
   CONFIRMAR ENTREGA (SEM FORM)
================================ */
confirmarBtn.addEventListener("click", async () => {
  try {
    confirmarBtn.disabled = true;
    confirmarBtn.innerText = "Processando...";

    const payload = {
      txid,
      nick: form.nick.value,
      jogador_id: form.id.value,
      whatsapp: form.telefone.value,
      email_cliente: form.email_cliente.value,
      horario: new Date().toLocaleString("pt-BR"),
    };

    if (!payload.nick || !payload.jogador_id || !payload.whatsapp || !payload.email_cliente) {
      alert("Preencha todos os campos.");
      confirmarBtn.disabled = false;
      confirmarBtn.innerText = "Confirmar Entrega";
      return;
    }

    const res = await fetch(
      "https://saint-echo-backend.neuroniosgames.workers.dev/submit-order",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }
    );

    if (!res.ok) throw new Error();

    window.location.href = "confirmado.html";

  } catch (err) {
    alert("Erro ao confirmar entrega. Tente novamente.");
    confirmarBtn.disabled = false;
    confirmarBtn.innerText = "Confirmar Entrega";
  }
});
</script>

</body>
</html>
