<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Concluindo Compra ‚µö..</title>
<link rel="icon" type="image/png" href="img/favicon.png">
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background:
    radial-gradient(circle at top, rgba(255, 200, 0, 0.04), transparent 60%),
    #000;
}
#parallax-wrapper {
  perspective: 1200px;
  transform-style: preserve-3d;
}
.card-depth {
  transition: transform 0.2s ease-out;
  will-change: transform;
}
.disabled {
  opacity: 0.4;
  pointer-events: none;
}

/* STATUS VISUAL */
.status {
  font-weight: bold;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 20px;
}
.status-pending {
  color: #facc15;
  box-shadow: 0 0 12px rgba(250,204,21,0.5);
}
.status-approved {
  color: #4ade80;
  box-shadow: 0 0 14px rgba(74,222,128,0.6);
}
.status-refused {
  color: #f87171;
  box-shadow: 0 0 14px rgba(248,113,113,0.6);
}
</style>
</head>

<body class="bg-black text-white font-sans">

<div id="parallax-wrapper">
<div class="max-w-xl mx-auto p-6">

<h1 class="text-3xl mb-2 font-bold text-center glow-float">
continue para entrega
</h1>

<div id="status-box"
     class="status status-pending text-center">
Pagamento em an√°lise pelo Mercado Pago
</div>

<button
  id="retry-btn"
  class="hidden w-full bg-zinc-900 border border-yellow-500 text-yellow-400 py-2 rounded-lg mb-6">
<strong>VERIFICAR PAGAMENTO NOVAMENTE</strong>
</button>

<!-- FORM agora √© APENAS visual (sem action / submit real) -->
<form id="pedido-form" class="space-y-4 card-depth disabled">

  <input class="w-full p-2 rounded bg-zinc-800"
         name="nick"
         placeholder="Nome no jogo"
         required>

  <input class="w-full p-2 rounded bg-zinc-800"
         name="id"
         placeholder="ID da conta (somente n√∫meros)"
         required
         inputmode="numeric"
         pattern="[0-9]+"
         oninput="this.value = this.value.replace(/[^0-9]/g, '')">

  <input class="w-full p-2 rounded bg-zinc-800"
         name="telefone"
         placeholder="WhatsApp"
         required>

  <input class="w-full p-2 rounded bg-zinc-800"
         type="email"
         name="email_cliente"
         placeholder="Seu e-mail"
         required>

  <!-- BOT√ÉO N√ÉO √â SUBMIT -->
  <button
    id="confirmar-entrega"
    type="button"
    class="w-full bg-yellow-500 text-black py-2 rounded-lg">
Confirmar Entrega
  </button>

</form>

<div class="mt-8 bg-zinc-900 border border-yellow-500 text-yellow-400 p-4 rounded text-sm text-center card-depth">
<strong>Aten√ß√£o:</strong><br>
O formul√°rio s√≥ √© liberado ap√≥s confirma√ß√£o real do pagamento.
</div>

</div>
</div>

<script src="js/effects.js"></script>

<!-- DISCORD -->
<a href="https://discordapp.com/users/715081298254888990" target="_blank" id="discord-icon">
  <img src="img/discord.png" alt="Discord" />
</a>

<style>
#discord-icon {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  z-index: 1000;
}
#discord-icon:hover {
  transform: scale(1.1);
}
</style>

<!-- BOT√ÉO SUPORTE -->
<div id="support-btn">
  <img src="https://cdn.discordapp.com/attachments/1460866723610890347/1461617258592735286/Sem_Titulodsadasdsad-1.png?ex=696b34a5&is=6969e325&hm=10f3578530f2f9ed9812a797d8c4da3350a5d2050fefde150f539e6566a7c099&" alt="Suporte" />
</div>

<style>
#support-btn {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #FFD700;
  color: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,.4);
  z-index: 1000;
}
#support-btn:hover {
  transform: scale(1.08);
}
</style>

<div id="support-modal">
  <form id="support-form">
    <h2>Contato com Suporte</h2>

    <input name="name" placeholder="Nome completo" required>
    <input name="whatsapp" placeholder="WhatsApp" required>
    <input name="email" type="email" placeholder="Email" required>
    <input name="subject" placeholder="Assunto" required>
    <textarea name="message" placeholder="Mensagem" required></textarea>

    <button type="submit">Enviar</button>
  </form>
</div>

<style>
#support-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  z-index: 1001;
}
#support-form {
  background: #111;
  color: #fff;
  max-width: 400px;
  margin: 10% auto;
  padding: 20px;
  border-radius: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
#support-form input,
#support-form textarea {
  padding: 10px;
  border-radius: 8px;
  border: none;

  background: #fff;   /* fundo do campo */
  color: #111;        /* texto que o cliente digita */
}
</style>

<script>
const btn = document.getElementById("support-btn");
const modal = document.getElementById("support-modal");

btn.onclick = () => modal.style.display = "block";
modal.onclick = e => {
  if (e.target === modal) modal.style.display = "none";
};
</script>

<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script>
(function(){
  emailjs.init("fjXHE6FnezGdisp_s");
})();

document.getElementById("support-form").addEventListener("submit", function(e){
  e.preventDefault();

  emailjs.sendForm(
    "service_cuecopv",
    "template_m4anla3",
    this
  ).then(() => {
    alert("Mensagem enviada com sucesso!");
    this.reset();
    document.getElementById("support-modal").style.display = "none";
  }, err => {
    alert("Erro ao enviar mensagem");
    console.error(err);
  });
});
</script>

<footer class="w-full mt-16 border-t border-gray-700 pt-8 pb-6">
  <div class="max-w-5xl mx-auto text-center text-sm text-gray-300 space-y-4">

    <!-- Linha 2: M√©todos de pagamento -->
    <div class="flex flex-wrap justify-center items-center gap-4 mt-4">
      <img src="https://cdn.discordapp.com/attachments/1460866723610890347/1461587430980190431/7406-pix.png?ex=696b18de&is=6969c75e&hm=418533400fbf11e255f184bae771727e2b94c4608a0cac832a638daf88441193&" alt="Pix" class="h-6">
      <img src="https://cdn.discordapp.com/attachments/1460866723610890347/1461588101267718319/visa-4-logo-png-transparent.png?ex=696b197e&is=6969c7fe&hm=e8c145468f1a9e96c3f2306377245e9d0db946a192049ae8e4af82bc44e0a1f9&" alt="Visa" class="h-6">
      <img src="https://cdn.discordapp.com/attachments/1460866723610890347/1461588456345043005/master-card-icon.png?ex=696b19d2&is=6969c852&hm=ffdca7ea0aabfa8ccbdb41806f725909fb166c2ab0ebdb4fc5da11588635c146&" alt="MasterCard" class="h-6">
      <img src="https://cdn.discordapp.com/attachments/1460866723610890347/1461588579871494154/mercado-pago-logo-png_seeklogo-342347.png?ex=696b19f0&is=6969c870&hm=1f7b995220f75a4510570b320ba810ddca91904181b640081aba14f026dad79f&" alt="Mercado Pago" class="h-6">
    </div>
    
    <!-- Linha 1: Seguran√ßa b√°sica -->
    <div class="flex flex-wrap justify-center font-semibold gap-6">
      <span>üîí Pagamento seguro</span>
      <span>üßæ Compra protegida</span>
      <span>‚ö° Entrega digital autom√°tica / Verifica√ß√£o manual</span>
    </div>

    <!-- Linha 3: Selos textuais (subconsciente trabalha aqui) -->
    <div class="flex flex-wrap justify-center gap-6 mt-4 text-xs font-semibold uppercase tracking-wide">
      <span>üîê SSL Secure Checkout</span>
      <span>üßæ Terms Accepted</span>
      <span>‚öôÔ∏è Entrega manual ap√≥s confirma√ß√£o</span>
      <span>‚è±Ô∏è Atendimento 24 horas ON</span>
    </div>

    <!-- Linha 4: Claims de confian√ßa (estilo marketplaces grandes) -->
    <div class="valor-glow2 flex flex-wrap justify-center gap-6 mt-4 font-semibold">
      <span>‚úî Secure Digital Delivery</span>
      <span>‚úî Verified Payment Flow</span>
      <span>‚úî Manual In-Game Delivery</span>
      <span>‚úî Terms Accepted & Logged</span>
    </div>

    <!-- Linha 5: Legal -->
    <div class="mt-6 text-xs text-gray-400">
      <a href="https://saintsgs-hub.github.io/tos.html" class="underline">Termos de Uso</a> ‚Ä¢
      <a href="https://saintsgs-hub.github.io/privacidade.html" class="underline">Pol√≠tica de Privacidade</a>
    </div>

  </div>
</footer>
  
<script>
const form = document.getElementById("pedido-form");
const statusBox = document.getElementById("status-box");
const retryBtn = document.getElementById("retry-btn");
const confirmarBtn = document.getElementById("confirmar-entrega");

const workerUrl = 'https://saint-echo-backend.neuroniosgames.workers.dev';

// l√™ txid da URL (collection_id / payment_id / id)
const params = new URLSearchParams(window.location.search);
let txid = params.get("payment_id") || params.get("collection_id") || params.get("id") || null;

// tenta preference_id do localStorage se txid ausente
let preferenceId = null;
try { const p = JSON.parse(localStorage.getItem('saint_pref') || 'null'); preferenceId = p?.preference_id || null; } catch(e){ preferenceId = null; }

function setStatusPending() {
  statusBox.className = "status status-pending text-center";
  statusBox.innerText = "Pagamento em an√°lise pelo Mercado Pago";
  retryBtn.classList.add("hidden");
}
function setStatusApproved() {
  statusBox.className = "status status-approved text-center";
  statusBox.innerText = "Pagamento aprovado ‚úî";
  form.classList.remove("disabled");
}
function setStatusNotApproved() {
  statusBox.className = "status status-pending text-center";
  statusBox.innerText = "Pagamento ainda n√£o confirmado. Verifique novamente.";
  retryBtn.classList.remove("hidden");
}

async function checkPreference(prefId) {
  const res = await fetch(`${workerUrl}/check-preference`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ preference_id: prefId })
  });
  return res.json();
}

async function validarPagamento() {
  setStatusPending();

  // Se n√£o h√° txid, tenta descobrir via preference_id
  if (!txid && preferenceId) {
    const prefResp = await checkPreference(preferenceId);
    if (prefResp.found && prefResp.mp_payment_id) {
      txid = prefResp.mp_payment_id;
    } else {
      setStatusNotApproved();
      return;
    }
  }

  if (!txid) {
    setStatusNotApproved();
    return;
  }

  // Chama /submit-order apenas para validar (sem dados finais)
  const consent = JSON.parse(localStorage.getItem("saint_consent") || 'null');
  const consentId = consent?.consent_id || null;
  if (!consentId) {
    alert('Consentimento n√£o encontrado. Volte √† home e aceite os termos.');
    return;
  }

  try {
    const res = await fetch(`${workerUrl}/submit-order`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ txid, consent_id: consentId })
    });

    const j = await res.json();
    // se backend retornou ok => pagamento confirmado e order criada (idempotente)
    if (res.ok && j.ok) {
      setStatusApproved();
    } else {
      // pagamento ainda n√£o aprovado
      setStatusNotApproved();
    }
  } catch (err) {
    console.error('Erro validando pagamento:', err);
    setStatusNotApproved();
  }
}

retryBtn.addEventListener("click", validarPagamento);
validarPagamento(); // tentativa autom√°tica na carga

confirmarBtn.addEventListener("click", async () => {
  try {
    confirmarBtn.disabled = true;
    confirmarBtn.innerText = "Processando...";

    const consent = JSON.parse(localStorage.getItem("saint_consent") || 'null');
    const consentId = consent?.consent_id || null;
    if (!consentId) throw new Error('Consent missing');

    const payload = {
  txid,
  preference_id: preferenceId,
  consent_id: consentId,
  nick: form.nick.value,
  jogador_id: form.id.value,
  whatsapp: form.telefone.value,
  email_cliente: form.email_cliente.value,
  horario: new Date().toLocaleString("pt-BR"),
  cidade: localStorage.getItem("cidade"),
  estado: localStorage.getItem("estado"),
  pais: localStorage.getItem("pais"),
  produto: localStorage.getItem("produto") || "60 Echo Beads"
};

    if (!payload.nick || !payload.jogador_id || !payload.whatsapp || !payload.email_cliente) {
      alert("Preencha todos os campos.");
      confirmarBtn.disabled = false;
      confirmarBtn.innerText = "Confirmar Entrega";
      return;
    }

    const res = await fetch(`${workerUrl}/submit-order`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error('submit failed');

    // sucesso
    window.location.href = "confirmado.html";
  } catch (err) {
    alert("Erro ao confirmar entrega. Tente novamente.");
    console.error(err);
    confirmarBtn.disabled = false;
    confirmarBtn.innerText = "Confirmar Entrega";
  }
});
</script>

<script>
  // Verifica se o usu√°rio j√° aceitou
  const consent = localStorage.getItem("saint_consent");
  if (consent && window.startBackgroundMusic) {
    window.startBackgroundMusic();
  }
</script>

</body>
</html>
